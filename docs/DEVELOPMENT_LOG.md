# 開発ログ

このファイルには、プロジェクトの開発進捗と作業履歴を記録します。

---

## 2026年

### 2026-01-27 - 動画生成完了後の表示問題修正

#### 実施内容
- 動画生成完了後に動画が正しく表示されない問題（読み込み中のまま）を修正

#### 完了項目
- [x] 動画生成完了後に`st.rerun()`を追加して画面を再描画
- [x] `st.video()`に`format="video/mp4"`を明示的に指定

#### 実装した修正
**動画表示の問題修正**:
- 動画生成処理完了後に`st.rerun()`を呼び出し、新しいレンダリングサイクルで動画を表示
- Streamlitの同一実行サイクル内でのバイトデータ読み込み問題を回避
- MIMEタイプを明示することでブラウザでの再生を確実に

#### 変更ファイル
- `ui/pages/video_page.py` - 動画生成後のrerun追加、st.video()のformat指定

---

### 2026-01-27 - 動画生成設定の初期値変更

#### 実施内容
- 動画生成設定の初期値をより実用的な値に変更

#### 完了項目
- [x] 字幕の内容の初期値を「セリフ」に変更
- [x] 縁取りの太さの初期値を3に変更
- [x] 字幕の位置の初期値を500pxに変更
- [x] 背景動画の初期値を最新ファイル自動選択に変更
- [x] 画像アニメーションの初期値を有効に変更
- [x] アニメーションの強さの初期値を1.1に変更

#### 変更内容
| 設定項目 | 変更前 | 変更後 |
|---------|--------|--------|
| 字幕の内容 | 見出し | セリフ |
| 縁取りの太さ | 2 | 3 |
| 字幕の位置（下から） | 50px | 500px |
| 背景動画 | なし | 最新のファイル |
| 画像アニメーション | オフ | オン |
| アニメーションの強さ | 1.2 | 1.1 |

#### 変更ファイル
- `ui/pages/video_page.py` - セッションステート初期値、クッキー読み込み時のデフォルト値

---

### 2026-01-27 - 音声ファイル検索と動画表示の修正

#### 実施内容
- 音声ファイル検索で最新のファイルを使用するように修正
- 動画表示をバイトデータに変更（ローディング問題の解消）

#### 完了項目
- [x] 音声ファイル検索の改善（最新ファイル優先）
- [x] 大文字拡張子（MP3, WAV）への対応
- [x] 動画表示方法の修正（st.video()にバイトデータを渡す）

#### 実装した修正
**音声ファイル検索の改善**:
- 同じシーン番号の音声ファイルが複数ある場合、最新のファイル（更新日時が最新）を使用
- 画像ファイルと同じロジックに統一
- 大文字拡張子（MP3, WAV）にも対応

**動画表示の修正**:
- `st.video(str(video_path))`から`st.video(video_data)`に変更
- ファイルパスではなくバイトデータを直接渡すことで、ローディング問題を解消

#### 変更ファイル
- `ui/pages/video_page.py` - 音声ファイル検索、動画表示

---

### 2026-01-27 - 画像アニメーション機能の追加と各種修正

#### 実施内容
- 画像アニメーション機能の追加（Ken Burns効果）
- クッキー保存機能の改善
- 動画ダウンロード機能の修正
- 動画表示方法の改善

#### 完了項目
- [x] 画像アニメーション機能（5種類のエフェクト）
- [x] アニメーション強度の調整スライダー
- [x] クッキーマネージャーの修正（警告解消）
- [x] 動画ダウンロードボタンの修正
- [x] 動画表示のst.video()への変更

#### 実装した機能
**画像アニメーション機能**:
- ゆっくりズームアップ（中央から拡大）
- 右から左へスライド
- 左から右へスライド
- 上から下へスライド
- 下から上へスライド
- 各シーンにランダムで適用
- アニメーション強度の調整（1.1〜1.5倍）

**クッキー保存の改善**:
- セッションステートでCookieManager管理
- `@st.cache_resource`の警告を解消
- アニメーション設定もクッキーに保存

**動画ダウンロード修正**:
- ダウンロードボタンに一意のkeyを追加
- base64エンコードをst.video()に変更（メモリ節約）

#### 変更ファイル
- `video/video_editor.py` - アニメーション効果の実装
- `ui/pages/video_page.py` - アニメーションUI、クッキー修正、ダウンロード修正

#### 備考
- アニメーション有効時は動画生成に時間がかかる
- 仕様書（README_PLAN.md）を更新

---

### 2026-01-27 - 動画編集機能の強化（字幕・背景動画・クッキー保存）

#### 実施内容
- 字幕内容の選択機能（見出し/セリフ）
- 字幕位置の微調整機能（下からのオフセット指定）
- 背景動画のループ再生機能
- 設定値のクッキー保存機能（ブラウザ更新後も保持）

#### 完了項目
- [x] 字幕ソースの選択（subtitle=見出し, dialogue=セリフ）
- [x] 字幕位置の調整スライダー（0〜500px）
- [x] 背景動画フォルダ（`output/bgvideos/`）の追加
- [x] 背景動画のセレクトボックス選択
- [x] 背景動画の自動ループ処理
- [x] `extra-streamlit-components`パッケージの導入
- [x] クッキーによる設定値の永続化

#### 実装した機能
**字幕機能の強化**:
- 「見出し（subtitle）」と「セリフ（dialogue）」の選択
- 字幕の下からの位置をピクセル単位で調整可能
- 設定値がセッション中保持される

**背景動画機能**:
- `output/bgvideos/`フォルダの動画をセレクトボックスで選択
- 動画の長さに合わせて背景動画を自動ループ
- 背景動画の音声は使用せず、ナレーション音声を保持
- 背景動画は動画サイズ（1080x1920）に自動リサイズ

**クッキー保存機能**:
- `extra-streamlit-components`の`CookieManager`を使用
- 字幕設定、背景動画選択などを自動保存
- ブラウザを閉じても設定が保持される

#### 変更ファイル
- `config/config.py` - `output_bgvideos_dir`パスの追加
- `utils/file_manager.py` - `list_bgvideos()`メソッドの追加
- `video/video_editor.py` - 字幕ソース選択、位置調整、背景動画合成
- `ui/pages/video_page.py` - UI追加、クッキー保存機能
- `requirements.txt` - `extra-streamlit-components`追加

#### 備考
- 背景動画はMP4/MOV/AVI形式に対応
- クッキーの有効期限は無期限（ブラウザが削除するまで）
- 仕様書（README_PLAN.md）を更新

---

### 2026-01-27 - ストック画像紐づけ機能の実装

#### 実施内容
- 画像生成ページに「ストック画像を紐づける」ボタンを追加
- `output/stock_images/`フォルダの画像をシーンにランダム割り当てする機能を実装
- 画像表示サイズの改善（サムネイル表示、クリックで拡大）
- 動画生成での画像検出の改善（大文字拡張子対応）

#### 完了項目
- [x] ストック画像紐づけ機能の実装
- [x] `output/stock_images/`ディレクトリの自動作成
- [x] ランダムシャッフルによる画像割り当て（重複なし）
- [x] 拡張子の小文字統一処理
- [x] 画像サムネイル表示（3列レイアウト、幅200px）
- [x] 拡大表示機能（expanderを使用）
- [x] 動画生成での大文字拡張子対応

#### 実装した機能
**ストック画像紐づけシステム**:
- `output/stock_images/`から画像ファイルを取得
- `random.sample()`でランダムにシャッフル
- 各シーンに1つずつ画像を割り当て（同じ画像は一度のみ使用）
- 画像を`output/images/`にコピー（拡張子は小文字に統一）
- OpenAI APIを使用しないためコスト節約

**画像表示の改善**:
- 「生成された画像ファイル」セクションを3列レイアウトに変更
- サムネイル表示（幅200px）で一覧性を向上
- 「🔍 拡大表示」expanderでフルサイズ画像を確認可能

**動画生成の画像検出改善**:
- 大文字拡張子（.PNG, .JPG, .JPEG）も検索対象に追加
- 同じシーンに複数画像がある場合は最新ファイルを使用

#### 変更ファイル
- `config/config.py` - `output_stock_images_dir`パスの追加
- `utils/file_manager.py` - `list_stock_images()`メソッドの追加
- `ui/pages/image_page.py` - ストック画像紐づけボタン、サムネイル表示
- `ui/pages/video_page.py` - 大文字拡張子の検索パターン追加

#### 備考
- シーン数より多くのストック画像が必要（足りない場合はエラー表示）
- 毎回ランダムに選ばれるため、実行するたびに異なる組み合わせ
- 仕様書（README_PLAN.md）を更新

---

### 2026-01-26 - 動画編集機能の実装完了

#### 実施内容
- 動画編集モジュール（video/video_editor.py）の実装
- 動画編集UIページ（ui/pages/video_page.py）の実装
- main.pyの更新（動画編集ページの統合）
- MoviePy 1.0.3へのダウングレード（互換性のため）
- Pillow互換性パッチの追加
- 字幕機能の実装（PILベース）
- 日本語フォント対応
- 動画表示サイズの調整

#### 完了項目
- [x] MoviePyを使用した動画編集機能
- [x] 画像と音声の同期処理
- [x] 字幕の自動追加機能（PILベース）
- [x] 日本語フォント対応（ヒラギノ角ゴシック）
- [x] 字幕スタイル設定機能
- [x] 動画のプレビュー表示（30%サイズ）
- [x] 動画のエクスポート・ダウンロード機能
- [x] ファイル存在確認機能

#### 実装した機能
**動画編集システム**:
- MoviePyを使用した動画生成
- 台本データから自動的に動画を構築
- 各シーンの画像と音声を同期
- 複数シーンの結合処理

**字幕システム**:
- PILを使用した字幕画像の生成
- 日本語フォント（ヒラギノ角ゴシック）の自動検出
- テキストの自動折り返し（日本語対応）
- 縁取り（ストローク）機能
- 字幕スタイルのカスタマイズ（フォントサイズ、色、縁取り）

**UI機能**:
- 台本の選択機能
- 画像・音声ファイルの存在確認
- 字幕スタイル設定パネル
- 動画生成ボタン
- 動画プレビュー（30%サイズ）
- 動画ダウンロード機能
- 保存済み動画の一覧表示

#### 技術詳細
- MoviePy 1.0.3を使用（2.x系との互換性問題のため）
- Pillow 11.3.0との互換性パッチ（Image.ANTIALIAS → Image.LANCZOS）
- PILを使用した字幕画像生成（TextClipの代わり）
- macOSのシステムフォント（ヒラギノ角ゴシック）を使用
- HTMLを使用した動画表示サイズの制御

#### 解決した問題
- MoviePy 2.x系のインポートエラー → 1.0.3にダウングレード
- Pillow 11.3.0のImage.ANTIALIAS削除 → 互換性パッチを追加
- TextClipの作成失敗 → PILベースの実装に変更
- 日本語の文字化け → ヒラギノ角ゴシックフォントを使用
- 動画表示サイズが大きすぎる → HTMLで30%サイズに調整

#### 備考
- MoviePy 1.0.3は古いバージョンですが、安定性を優先
- 字幕機能はPILベースで実装（ImageMagick不要）
- 動画ファイルが大きい場合、base64エンコードでメモリ使用量が増える可能性あり
- 次フェーズ：トランジション効果の追加（オプション）

---

### 2026-01-26 - 画像生成設定の最適化

#### 実施内容
- 画像生成品質設定を`standard`に設定（`hd`から変更）
- 画像生成スタイル設定を`vivid`に設定（`natural`から変更）
- プロンプト追加処理のシンプル化
- サニタイズ機能の無効化（プロンプトがそのまま使用される）

#### 完了項目
- [x] 品質設定を`standard`に変更（生成時間とコストの最適化）
- [x] スタイル設定を`vivid`に変更（鮮やかで詳細な表現）
- [x] プロンプト追加処理の改善（余計な装飾テキストを削除）
- [x] サニタイズ機能の無効化（実写画像生成のため）

#### 実装した変更
**画像生成設定**:
- `OPENAI_IMAGE_QUALITY = "standard"` - 標準品質設定
- `OPENAI_IMAGE_STYLE = "vivid"` - 鮮やかで詳細な表現

**プロンプト処理**:
- 「画像生成指示」の内容をシンプルに改行で結合
- 「【追加指示】」「上記の指示も考慮して...」などの装飾テキストを削除
- サニタイズ処理を無効化（プロンプトがそのままDALL-E 3に送信される）

#### 技術詳細
- DALL-E 3の`style`パラメータに`vivid`を指定
- プロンプト構築時に余計な指示文を追加しない
- ユーザーが「画像生成指示」に入力した内容が直接反映される

#### 備考
- 実写風の画像生成を目的とした設定変更
- プロンプトのシンプル化により、意図した画像が生成されやすくなる
- サニタイズ無効化により、コンテンツポリシー違反のエラーが出る可能性がある

---

### 2026-01-26 - 参考画像機能の追加

#### 実施内容
- 参考画像アップロード機能の追加
- GPT-4oを使用した参考画像のトンマナ・タッチ分析機能
- 分析結果の表示機能
- 参考画像のスタイルを反映した画像生成機能

#### 完了項目
- [x] 参考画像のアップロード機能（PNG, JPG, JPEG対応）
- [x] GPT-4oによる画像分析（色彩、タッチ、構図、トーン、スタイル）
- [x] 分析結果の言語化と表示
- [x] 分析結果をプロンプトに組み込んだ画像生成

#### 実装した機能
**参考画像分析システム**:
- アップロードされた画像をGPT-4oで分析
- トンマナ、タッチ、色彩、構図、スタイルを詳細に言語化
- 分析結果を画像生成プロンプトに自動反映

**UI機能**:
- 画像アップロード機能
- 「🔍 参考画像を分析」ボタン
- 分析結果の表示エリア
- 参考画像のプレビュー表示

#### 技術詳細
- GPT-4oのVision APIを使用して画像を分析
- base64エンコードで画像をAPIに送信
- 分析結果をプロンプトに組み込んでDALL-E 3で画像生成

#### 備考
- 参考画像はオプション機能です（アップロードしなくても画像生成可能）
- 分析には数秒かかります
- 分析結果はセッション中保持されます

---

### 2026-01-26 - 画像生成機能の実装完了

#### 実施内容
- 画像生成モジュール（images/image_generator.py）の実装
- 画像処理モジュール（images/image_processor.py）の実装
- 画像生成UIページ（ui/pages/image_page.py）の実装
- main.pyの更新（画像生成ページの統合）

#### 完了項目
- [x] DALL-E 3を使用した画像生成機能
- [x] 台本の全シーン一括画像生成機能
- [x] シーン別個別画像生成機能
- [x] 画像のプレビュー表示機能
- [x] 動画サイズ（1080x1920）への自動リサイズ機能
- [x] 画像ファイルの保存・管理機能

#### 実装した機能
**画像生成システム**:
- DALL-E 3を使用した高品質な画像生成
- 台本の各シーンのimage_promptから画像を自動生成
- 9:16形式（1080x1920）への自動リサイズ

**UI機能**:
- 保存された台本の選択機能
- 全シーン一括生成と個別生成の両対応
- 画像のプレビュー表示
- 画像ファイルのダウンロード機能

#### 備考
- OpenAI APIキーが必要です（DALL-E 3使用）
- 画像生成には数秒から数十秒かかります
- 次フェーズ：動画編集機能の実装

---

### 2026-01-26 - 音声生成機能の実装完了

#### 実施内容
- 音声生成モジュール（audio/audio_generator.py）の実装
- 音声処理モジュール（audio/audio_processor.py）の実装
- 音声生成UIページ（ui/pages/audio_page.py）の実装
- main.pyの更新（音声生成ページの統合）

#### 完了項目
- [x] ElevenLabs APIを使用した音声生成機能
- [x] 台本の全シーン一括音声生成機能
- [x] シーン別個別音声生成機能
- [x] 音声のプレビュー再生機能
- [x] 音声ファイルの保存・管理機能
- [x] 音声設定（安定性、類似度ブースト）の調整機能

#### 実装した機能
**音声生成システム**:
- ElevenLabs APIを使用した日本語音声生成
- 台本の各シーンのdialogueから音声を自動生成
- 音声の安定性と類似度の調整機能

**UI機能**:
- 保存された台本の選択機能
- 全シーン一括生成と個別生成の両対応
- 音声のプレビュー再生
- 音声ファイルのダウンロード機能

#### 備考
- ElevenLabs APIキーとVoice IDが必要です
- 音声生成には数秒から数十秒かかります
- 次フェーズ：画像生成機能の実装

---

### 2026-01-26 - 台本生成指示機能の追加

#### 実施内容
- 「台本生成指示」テキストエリアの追加
- 台本生成時に指示を考慮する機能の実装
- 仕様書の更新（docs/README_PLAN.md）

#### 完了項目
- [x] 「台本生成指示」テキストエリアの追加
- [x] 台本生成ロジックへの指示パラメータの追加
- [x] プロンプト生成時の指示の反映
- [x] 仕様書の更新

#### 実装した機能
**台本生成指示システム**:
- ユーザーが台本生成時の特別な指示を入力可能
- 指示をプロンプトに反映して台本を生成
- 参考台本やインサイトと組み合わせて使用可能

#### 備考
- 台本生成指示はオプションです
- 参考台本、インサイト、指示を組み合わせて使用できます
- 次フェーズ：音声生成機能の実装

---

### 2026-01-26 - 台本生成機能の仕様変更と実装

#### 実施内容
- 台本生成機能の仕様変更（参考台本からのインサイト抽出機能を追加）
- インサイト抽出機能の実装（scripts/script_generator.py）
- インサイトベースの台本生成機能の実装
- UIの更新（参考台本テキストエリアとインサイト表示エリアの追加）
- 仕様書の更新（docs/README_PLAN.md）

#### 完了項目
- [x] 参考台本テキストエリアの追加
- [x] 視聴者インサイト抽出機能の実装
- [x] インサイト表示エリアの追加
- [x] インサイトベースの台本生成機能の実装
- [x] 仕様書の更新

#### 実装した機能
**インサイト抽出システム**:
- 参考台本から視聴者のインサイトを自動抽出
- GPT-4oを使用した深い分析
- 抽出したインサイトの表示

**インサイトベースの台本生成**:
- 抽出したインサイトを満足させる台本の生成
- 視聴者のニーズに応じたコンテンツ作成

#### 備考
- 参考台本はオプションです（入力しなくても台本生成は可能）
- インサイト抽出には追加のAPI呼び出しが必要です
- 次フェーズ：音声生成機能の実装

---

### 2026-01-26 - 台本生成機能の実装完了

#### 実施内容
- 台本生成モジュール（scripts/script_generator.py）の実装
- 台本検証モジュール（scripts/script_validator.py）の実装
- 台本パーサーモジュール（scripts/script_parser.py）の実装
- 台本生成UIページ（ui/pages/script_page.py）の実装
- main.pyの更新（ナビゲーション機能の追加）

#### 完了項目
- [x] GPT-4oを使用した台本生成機能
- [x] 台本の検証・正規化機能
- [x] JSON形式での台本出力
- [x] Streamlit UIでの台本生成インターフェース
- [x] 台本の保存・ダウンロード機能
- [x] ナビゲーション機能の実装

#### 実装した機能
**台本生成システム**:
- GPT-4oを使用した台本自動生成
- トピック、時間、シーン数、スタイルの指定
- JSON形式での構造化された台本出力

**UI機能**:
- 台本生成フォーム
- 生成された台本のプレビュー表示
- 各シーンの詳細表示
- 台本の保存・ダウンロード機能

#### 備考
- OpenAI APIキーが必要です（.envファイルに設定）
- 台本生成には数秒かかります
- 次フェーズ：音声生成機能の実装

---

### 2026-01-26 - 基盤システム実装完了

#### 実施内容
- 設定管理システム（config/config.py, config/constants.py）の実装
- ログシステム（utils/logger.py）の実装
- ファイル管理システム（utils/file_manager.py）の実装
- main.pyの更新（設定管理システムの統合）

#### 完了項目
- [x] 設定管理システムの実装
- [x] 環境変数の読み込み機能
- [x] APIキーの検証機能
- [x] ログシステムの実装
- [x] ファイル管理システムの実装
- [x] 出力ディレクトリの自動作成機能
- [x] main.pyへの統合

#### 実装した機能
**設定管理システム**:
- 環境変数の読み込み（.envファイル）
- APIキーの検証
- 動画設定の管理
- 出力ディレクトリの管理

**ログシステム**:
- コンソール出力とファイル出力の両対応
- ログレベルの設定
- モジュールごとのロガー管理

**ファイル管理システム**:
- 台本の保存・読み込み（JSON形式）
- ファイルパスの生成と管理
- ファイル一覧の取得機能

#### 備考
- すべてのシステムが正常に動作することを確認
- 出力ディレクトリとログディレクトリが自動作成されることを確認
- 次フェーズ：台本生成機能の実装

---

### 2026-01-26 - 環境構築完了

#### 実施内容
- Python仮想環境（venv）の作成
- 依存パッケージのインストール（requirements.txt）
- プロジェクトディレクトリ構造の作成
- 各モジュールディレクトリに`__init__.py`を追加
- `.env.example`ファイルの作成
- 基本的な`main.py`の作成（Streamlitアプリのエントリーポイント）
- Streamlitの動作確認

#### 完了項目
- [x] Python仮想環境の作成
- [x] 依存パッケージのインストール
- [x] プロジェクトディレクトリ構造の作成
- [x] Pythonパッケージの初期化
- [x] 環境変数テンプレートの作成
- [x] 基本的なStreamlitアプリの作成
- [x] Streamlitの動作確認（v1.53.1）

#### インストールされた主要パッケージ
- streamlit: 1.53.1
- openai: 2.15.0
- elevenlabs: 2.31.0
- moviepy: 2.2.1
- Pillow: 11.3.0
- python-dotenv: 1.2.1

#### 備考
- Python 3.13.7、FFmpeg 8.0が確認済み
- すべての依存パッケージが正常にインストール完了
- 次フェーズ：設定管理システムとログシステムの実装

---

### 2026-01-26 - プロジェクト初期化とGitHubリポジトリ設定

#### 実施内容
- システム定義書（README_PLAN.md）の作成
- ディレクトリ構成案の策定
- requirements.txtの作成
- README.mdの作成
- .gitignoreの設定
- 開発ログファイルの作成
- ドキュメントファイルを`docs/`フォルダに整理
- Gitリポジトリの初期化
- GitHubリポジトリ（https://github.com/otochin/createmovie）への初回プッシュ

#### 完了項目
- [x] プロジェクト構造の設計
- [x] 依存パッケージリストの作成
- [x] ドキュメント整備
- [x] ドキュメントフォルダの整理
- [x] Gitリポジトリの初期化
- [x] GitHubへのプッシュ

#### 備考
- プロジェクトの基盤構築を完了
- すべてのドキュメントを`docs/`フォルダに整理
- GitHubリポジトリに正常にプッシュ完了

---

## 作業テンプレート

以下の形式で作業履歴を記録してください：

```markdown
### YYYY-MM-DD - [作業タイトル]

#### 実施内容
- 作業内容1
- 作業内容2

#### 完了項目
- [x] タスク1
- [x] タスク2
- [ ] 未完了タスク

#### 課題・問題点
- 問題1とその対応方法

#### 備考
- その他のメモ
```

---

## 開発フェーズ進捗

### Phase 1: 基盤構築
- [ ] プロジェクト構造の作成
- [ ] 依存パッケージのインストール
- [ ] 設定管理システムの実装
- [ ] ログシステムの実装

### Phase 2: 台本生成機能
- [ ] OpenAI API連携
- [ ] 台本生成ロジックの実装
- [ ] JSON形式での台本出力
- [ ] 台本プレビュー機能

### Phase 3: 音声生成機能
- [ ] ElevenLabs API連携
- [ ] 音声生成ロジックの実装
- [ ] 音声プレビュー機能

### Phase 4: 画像生成機能
- [ ] DALL-E 3 API連携
- [ ] 画像生成ロジックの実装
- [ ] 画像プレビュー機能

### Phase 5: 動画編集機能
- [ ] MoviePy統合
- [ ] 画像・音声の同期処理
- [ ] 字幕生成・配置機能
- [ ] 動画エクスポート機能

### Phase 6: GUI実装
- [ ] Streamlit UIの構築
- [ ] ワークフロー実装
- [ ] プレビュー機能の統合
- [ ] 再生成機能の実装

### Phase 7: テスト・最適化
- [ ] エラーハンドリングの強化
- [ ] パフォーマンス最適化
- [ ] UI/UXの改善
- [ ] ドキュメント整備
