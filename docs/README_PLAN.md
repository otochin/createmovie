# YouTubeショート動画生成ツール - システム定義書

## 1. プロジェクト概要

### 1.1 目的
インプット（テキストやトピック）から「台本・音声・画像・動画」を自動生成するGUIツールを開発します。
YouTubeショート（9:16形式、1080x1920）向けの高品質な動画を効率的に作成できることを目指します。

### 1.2 実行環境
- **OS**: macOS (MacBook Pro Mシリーズ対応)
- **Python**: 3.9以上推奨
- **ブラウザ**: Chrome, Safari, Firefox等（Streamlit対応）

### 1.3 主要技術スタック
- **GUIフレームワーク**: Streamlit
- **AI API**:
  - OpenAI API (GPT-4o) - 台本生成、画像生成（DALL-E 3）
  - ElevenLabs API - 音声生成（日本語・高品質）
- **動画編集**: MoviePy
- **動画処理**: FFmpeg
- **日本語処理**: pykakasi（漢字→ひらがな変換）
- **データ形式**: JSON（台本）、MP4（動画）、MP3/WAV（音声）、PNG/JPG（画像）

---

## 2. 機能要件

### 2.1 台本作成機能
- **入力**: 
  - ユーザーがテキストやトピックを入力
  - 参考台本（オプション）をテキストエリアに入力
  - 台本生成指示（オプション）をテキストエリアに入力
- **処理**: 
  1. 参考台本が提供された場合、GPT-4oを使用して視聴者のインサイトを抽出・分析
  2. 抽出したインサイトを基に、そのインサイトを満足させる台本を生成
  3. 台本生成指示が提供された場合、その指示を考慮して台本を生成
  4. 参考台本がない場合は、トピックから直接台本を生成
- **出力形式**: JSON形式
  ```json
  {
    "title": "動画タイトル",
    "insights": [
      "視聴者のインサイト1",
      "視聴者のインサイト2"
    ],
    "scenes": [
      {
        "scene_number": 1,
        "dialogue": "セリフテキスト",
        "dialogue_for_tts": "せりふてきすと（ひらがな・一部カタカナ、句読点入り。台本生成時にGPTが返す）",
        "image_prompt": "画像生成用プロンプト",
        "duration": 3.5,
        "subtitle": "字幕テキスト"
      }
    ],
    "insights": [
      "視聴者のインサイト1",
      "視聴者のインサイト2"
    ],
    "knowledge": [
      "参考台本から学んだ知識1",
      "参考台本から学んだ知識2"
    ],
    "total_duration": 60.0
  }
  ```
- **機能**:
  - 参考台本からの視聴者インサイト抽出
  - 参考台本からの知識抽出（具体的な事実、データ、専門知識、ノウハウなど）
  - 抽出したインサイトと知識の表示
  - インサイトと知識を基にした台本生成
  - 台本生成時にGPTが各シーンの`dialogue_for_tts`を返却（ひらがな・必要に応じカタカナ、句読点「、」「。」を適切に挿入）。未返却時のみローカルでひらがな変換して補完
  - 参考台本から知識も抽出する機能（インサイトと知識の両方を抽出）
  - 台本のプレビュー表示（ひらがな変換済みテキストも表示）
  - **台本の編集・保存機能**:
    - 編集モードの切り替え（編集モード/表示モード）
    - タイトル、説明の編集
    - 各シーンの編集（dialogue、dialogue_for_tts、subtitle、image_prompt、duration、scene_number）
    - 既存台本の読み込み・編集機能
    - 編集内容の保存（既存ファイルの上書き、または新規保存）
    - 台本生成時の自動保存機能
    - 台本生成後に編集用セレクトボックスに自動選択される機能
  - 再生成機能
  - 台本生成指示の初期値設定（デフォルト指示あり）
  - セリフの長さの調整（1秒あたり6〜8文字程度、詳細で具体的な内容）

### 2.2 音声生成機能
- **API**: ElevenLabs API
- **言語**: 日本語
- **品質**: 高品質（premium voice推奨）
- **出力**: MP3またはWAV形式
- **機能**:
  - 各シーンの音声を個別生成
  - `dialogue_for_tts`フィールドがあれば優先的に使用（漢字の読み間違いを防止）
  - `dialogue_for_tts`がない場合は`dialogue`を使用
  - `dialogue_for_tts`はカタカナを保持（固有名詞や専門用語の読み上げが正確）。句読点は台本生成時（GPT）で付与
  - 音声のプレビュー再生
  - 音声の再生成機能
  - 音声ファイルの保存管理

### 2.3 画像生成機能
- **API**: OpenAI DALL-E 3
- **出力サイズ**: ショート 1080x1920（9:16形式）/ 長尺 1920x1080（16:9形式）を選択可能
- **品質設定**: standard（標準品質）
- **スタイル設定**: vivid（鮮やかで詳細な表現）
- **機能**:
  - 動画フォーマットの選択（ショート / 長尺）。長尺選択時は 16:9 で生成・保存
  - 各シーン用の画像を自動生成
  - 参考画像のアップロード機能
  - 参考画像のトンマナ・タッチの言語化（GPT-4oを使用）
  - 言語化された情報の表示（参考のみ、プロンプトには含めない）
  - 画像生成指示の入力機能（ユーザーが自由に指示を追加可能）
  - プロンプトのシンプルな結合（余計な装飾テキストなし）
  - 画像のプレビュー表示（サムネイル＋拡大表示）
  - 画像の再生成機能
  - 画像ファイルの保存管理（ショート: `output/images/`、長尺: `output/images_long/`）
  - **ストック画像紐づけ機能**（API不使用）:
    - ショート: `output/stock_images/` の画像をシーンにランダム割り当て、`output/images/` に保存
    - 長尺: `output/stock_images_long/` の画像をシーンにランダム割り当て、`output/images_long/` に保存
    - 同じ画像は一度のみ使用（重複なし、セッション内でフォーマット別に追跡）
    - 拡張子の自動正規化（小文字統一）
  - **動画フォーマットの連動**:
    - 画像生成画面で選択した動画フォーマット（ショート/長尺）は、動画編集画面と共通の設定として連動する（セッション＋クッキーで保持）
  - **画像マッピング機能**:
    - 画像生成画面で割り当てた画像情報を保存（ショート: `{台本名}_image_mapping.json`、長尺: `{台本名}_image_mapping_long.json`）
    - 動画編集画面で同じ台本・同じフォーマットを選択すると、割り当てた画像が自動的に反映される
    - 画像マッピングファイル（`*_image_mapping.json`, `*_image_mapping_long.json`）は台本一覧から除外される（台本として読み込まれない）
  - **ストック画像紐づけ後の表示**:
    - 紐づけ時に出力ディレクトリを自動作成し、絶対パスで保存して表示の安定化を図る
    - 一覧表示はファイルをバイト列で読み込んで表示するため、パス差や環境差で画像が表示されない事象を防止
    - シーン番号でソートして表示。ファイルが存在しない場合は警告を表示

### 2.4 動画編集機能
- **ライブラリ**: MoviePy
- **出力形式**: MP4（H.264）
- **解像度**: ショート 1080x1920（9:16）/ 長尺 1920x1080（16:9）を動画生成設定で選択可能
- **機能**:
  - **動画サイズ（画像・動画フォーマット）の選択**: ショート（9:16, 1080×1920）または長尺（16:9, 1920×1080）。選択に応じて使用する画像・背景動画のフォルダが切り替わる
  - 画像と音声の同期（ショート時は `output/images/`、長尺時は `output/images_long/` の画像を使用）
  - **字幕機能**:
    - 字幕内容の選択（見出し/セリフ）
    - 字幕位置の微調整（下からのオフセット指定）
    - フォントサイズ、文字色、縁取りのカスタマイズ
    - 動画幅に合わせた折り返し（ショート時は1080px、長尺時は1920px）。余白・縁取りを考慮した幅制限ではみ出しを防止
  - **背景動画機能**:
    - ショート: `output/bgvideos/` フォルダの動画を背景として使用
    - 長尺: `output/bgvideos_long/` フォルダの動画を背景として使用
    - 動画の長さに合わせて自動ループ再生
    - セレクトボックスで背景動画を選択
  - **BGM機能**:
    - `output/bgm/`フォルダのWAVファイルを選択可能
    - 初期値は最新のWAVファイルを自動選択
    - BGM音量の調整（0.0〜1.0、デフォルト0.1）
    - BGMは動画の長さに合わせて自動ループ（音声クリップ用の結合・音量調整でショート・長尺共通で適用）
    - ナレーション音声とBGMを合成
  - **プログレスバー機能**:
    - 動画生成中に各処理段階の進捗を表示
    - 各シーンの処理状況、動画クリップの結合、背景動画の処理、BGMの処理、書き出し状況を表示
  - **画像アニメーション機能**:
    - アニメーション適用方法の選択（ランダム/個別指定）
    - ランダムモード：各シーンにランダムでアニメーション効果を適用（前のシーンと同じアニメーションは連続しない）
    - 個別指定モード：各シーンごとに個別にアニメーションを指定可能
    - アニメーションタイプ：
      - なし
      - ゆっくりズームアップ
      - 右から左へスライド / 左から右へスライド
      - 上から下へスライド / 下から上へスライド
    - 各シーンのアニメーション設定画面に画像を表示（3列レイアウト、約15%サイズ）
    - アニメーションの強さを調整可能（1.1〜1.5倍）
  - 動画のプレビュー
  - 動画のエクスポート・ダウンロード
  - **設定値のクッキー保存**:
    - ブラウザを閉じても設定が保持される
    - 字幕設定、背景動画選択、アニメーション設定を自動保存
  - **デフォルト初期値**:
    - 字幕を追加: オン
    - 字幕の内容: セリフ
    - 縁取りの太さ: 3
    - 字幕の位置（下から）: 500px
    - 背景動画: 最新のファイルを自動選択
    - BGM: 最新のWAVファイルを自動選択
    - BGM音量: 0.1
    - 画像アニメーション: 有効
    - アニメーションの適用方法: 個別指定
    - アニメーションの強さ: 1.1

### 2.5 GUI機能（Streamlit）
- **ワークフロー**:
  1. 入力画面：テキスト/トピック入力
  2. 台本生成：生成とプレビュー
  3. 音声生成：各シーンの音声生成とプレビュー
  4. 画像生成：各シーンの画像生成とプレビュー
  5. 動画編集：動画生成とプレビュー
  6. エクスポート：最終動画のダウンロード
- **UI要素**:
  - ステップごとの進捗表示
  - 各ステップでのプレビュー機能
  - 再生成ボタン（各ステップで利用可能）
  - 設定パネル（APIキー、音声設定等）
  - 動画フォーマット（ショート/長尺）は画像生成画面と動画編集画面で連動

---

## 3. ディレクトリ構成

```
createmovie/
├── README.md                    # プロジェクト説明書
├── requirements.txt            # Python依存パッケージ
├── .env.example                # 環境変数テンプレート
├── .gitignore                  # Git除外設定
│
├── docs/                       # ドキュメント
│   ├── README_PLAN.md         # システム定義書（本ファイル）
│   ├── DEVELOPMENT_LOG.md     # 開発ログ
│   ├── CHANGELOG.md           # 変更履歴
│   └── TODO.md                # TODOリスト
│
├── main.py                     # Streamlitアプリのエントリーポイント
│
├── config/                     # 設定管理
│   ├── __init__.py
│   ├── config.py              # アプリケーション設定
│   └── constants.py           # 定数定義
│
├── scripts/                    # 台本関連
│   ├── __init__.py
│   ├── script_generator.py    # GPT-4oを使用した台本生成
│   ├── script_validator.py    # 台本の検証・整形
│   └── script_parser.py       # JSON台本のパース処理
│
├── audio/                      # 音声関連
│   ├── __init__.py
│   ├── audio_generator.py     # ElevenLabs APIを使用した音声生成
│   └── audio_processor.py     # 音声ファイルの処理・変換
│
├── images/                     # 画像関連
│   ├── __init__.py
│   ├── image_generator.py     # DALL-E 3を使用した画像生成
│   └── image_processor.py     # 画像のリサイズ・加工
│
├── video/                      # 動画関連
│   ├── __init__.py
│   ├── video_editor.py        # MoviePyを使用した動画編集
│   ├── subtitle_generator.py  # 字幕の生成・配置
│   └── video_processor.py     # 動画の後処理
│
├── utils/                      # ユーティリティ
│   ├── __init__.py
│   ├── file_manager.py        # ファイルの保存・読み込み管理
│   ├── api_client.py          # APIクライアントの共通処理
│   ├── logger.py              # ログ管理
│   └── validators.py          # 入力値検証
│
├── ui/                         # UIコンポーネント
│   ├── __init__.py
│   ├── components.py          # Streamlitコンポーネント
│   ├── pages/                 # マルチページ構成（必要に応じて）
│   │   ├── __init__.py
│   │   ├── input_page.py     # 入力画面
│   │   ├── script_page.py    # 台本生成画面
│   │   ├── audio_page.py     # 音声生成画面
│   │   ├── image_page.py     # 画像生成画面
│   │   └── video_page.py     # 動画編集画面
│   └── styles.py             # CSSスタイル定義
│
└── output/                     # 生成物の保存先
    ├── scripts/               # 生成された台本JSON
    ├── audio/                 # 生成された音声ファイル
    ├── images/                # 生成された画像ファイル
    ├── videos/                # 生成された動画ファイル
    ├── stock_images/          # ストック画像・ショート用（ユーザーが配置）
    ├── stock_images_long/     # ストック画像・長尺用（ユーザーが配置）
    ├── images_long/           # 長尺用に生成・紐づけした画像
    ├── bgvideos/              # 背景動画・ショート用（ユーザーが配置）
    ├── bgvideos_long/         # 背景動画・長尺用（ユーザーが配置）
    └── bgm/                   # BGMファイル（ユーザーが配置）
```

---

## 4. 技術仕様

### 4.1 API仕様

#### OpenAI API
- **モデル**: GPT-4o
- **用途**: 台本生成、画像生成プロンプト作成
- **画像生成**: DALL-E 3
- **設定**: 温度、最大トークン数等を設定可能

#### ElevenLabs API
- **用途**: 日本語音声生成
- **品質**: Premium Voice推奨
- **設定**: 音声ID、安定性、類似度等を設定可能

### 4.2 ファイル形式
- **台本**: JSON（UTF-8）
- **音声**: MP3（推奨）またはWAV
- **画像**: PNG（推奨）またはJPG
- **動画**: MP4（H.264、AAC）

### 4.3 動画仕様
- **解像度**: ショート 1080x1920（縦型 9:16）/ 長尺 1920x1080（横型 16:9）を選択可能
- **フレームレート**: 30fps
- **ビットレート**: 5-10Mbps（推奨）
- **アスペクト比**: ショート 9:16 / 長尺 16:9

---

## 5. 開発フェーズ

### Phase 1: 基盤構築
- [ ] プロジェクト構造の作成
- [ ] 依存パッケージのインストール
- [ ] 設定管理システムの実装
- [ ] ログシステムの実装

### Phase 2: 台本生成機能
- [ ] OpenAI API連携
- [ ] 台本生成ロジックの実装
- [ ] JSON形式での台本出力
- [ ] 台本プレビュー機能

### Phase 3: 音声生成機能
- [ ] ElevenLabs API連携
- [ ] 音声生成ロジックの実装
- [ ] 音声プレビュー機能

### Phase 4: 画像生成機能
- [ ] DALL-E 3 API連携
- [ ] 画像生成ロジックの実装
- [ ] 画像プレビュー機能

### Phase 5: 動画編集機能
- [ ] MoviePy統合
- [ ] 画像・音声の同期処理
- [ ] 字幕生成・配置機能
- [ ] 動画エクスポート機能

### Phase 6: GUI実装
- [ ] Streamlit UIの構築
- [ ] ワークフロー実装
- [ ] プレビュー機能の統合
- [ ] 再生成機能の実装

### Phase 7: テスト・最適化
- [ ] エラーハンドリングの強化
- [ ] パフォーマンス最適化
- [ ] UI/UXの改善
- [ ] ドキュメント整備

---

## 6. セキュリティ・運用

### 6.1 APIキー管理
- 環境変数（`.env`）を使用
- `.env`ファイルは`.gitignore`に追加
- `.env.example`でテンプレートを提供

### 6.2 エラーハンドリング
- API呼び出しのエラーハンドリング
- ファイル操作のエラーハンドリング
- ユーザーフレンドリーなエラーメッセージ

### 6.3 ログ管理
- 開発用：詳細ログ
- 本番用：エラーログ中心

---

## 7. 今後の拡張可能性

- 複数言語対応
- 音声の感情表現調整
- 動画テンプレート機能
- バッチ処理機能
- クラウドストレージ連携
- 動画の自動アップロード機能

---

## 8. 参考資料

- [Streamlit Documentation](https://docs.streamlit.io/)
- [OpenAI API Documentation](https://platform.openai.com/docs)
- [ElevenLabs API Documentation](https://elevenlabs.io/docs)
- [MoviePy Documentation](https://zulko.github.io/moviepy/)
- [FFmpeg Documentation](https://ffmpeg.org/documentation.html)
